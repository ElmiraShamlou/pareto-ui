name: Build Dispatch

on:
  workflow_dispatch:
    inputs:
      os-version:
        description: "Operating system version"
        type: choice
        options:
          - windows-latest
          - macos-latest
        default: windows-latest
      project-pareto-repo:
        description: "Project PARETO repository to build from"
        type: string
        default: project-pareto/project-pareto
      project-pareto-branch:
        description: "Branch or tag for the Project PARETO repository"
        type: string
        default: main
      project-pareto-version:
        type: string
        default: '1.1.0'
      package-build-number:
        description: "Package build number (optional). Will be autogenerated based on the date if not provided."
        type: string
      windows-installer-target:
        description: "Windows installer target. This will only affect windows builds."
        type: choice
        options:
          - nsis
          # - portable
          - zip
        default: windows-latest

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      job-name: ${{ steps.generate-dynamic-inputs.outputs.job-name }}
      os: ${{ steps.generate-dynamic-inputs.outputs.os }}
    steps:
      - name: Generate dynamic inputs
        id: generate-dynamic-inputs
        run: |
          if [ "${{ inputs.os-version }}" == "windows-latest" ]; then
            echo "job-name=build ${{ inputs.windows-installer-target }}" >> $GITHUB_OUTPUT
            echo "os=windows" >> $GITHUB_OUTPUT
          else
            echo "job-name=build dmg" >> $GITHUB_OUTPUT
            echo "os=mac" >> $GITHUB_OUTPUT
          fi

  electron-build:
    needs: prepare
    uses: ./.github/workflows/app_build.yml
    name: ${{ needs.prepare.outputs.os }}
    with:
      job-name:  ${{ needs.prepare.outputs.job-name }}
      os-version: ${{ inputs.os-version }}
      package-build-number: ${{ inputs.package-build-number }}
      project-pareto-repo: ${{ inputs.project-pareto-repo }}
      project-pareto-branch: ${{ inputs.project-pareto-branch }}
      project-pareto-version: ${{ inputs.project-pareto-version }}
      windows-installer-target: ${{ inputs.windows-installer-target }}
    secrets: inherit
